name: Daily Regime Classifier Update

on:
  schedule:
    # Runs at 2 AM UTC every day (7:30 AM IST / 6 PM PST)
    - cron: '0 2 * * *'
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:

jobs:
  update-regime:
    # This runs on YOUR computer, not GitHub's servers
    runs-on: self-hosted
    
    steps:
      - name: Check environment
        shell: powershell
        run: |
          Write-Host "=== Environment Check ===" -ForegroundColor Cyan
          Write-Host "Time: $(Get-Date)" -ForegroundColor White
          Write-Host "Path: C:\Users\ahaan\CODE\Research Papers\ML Regime Classifier" -ForegroundColor White
          Write-Host "Python: $(python --version)" -ForegroundColor White
          
      - name: Run daily automation pipeline
        shell: powershell
        run: |
          Set-Location "C:\Users\ahaan\CODE\Research Papers\ML Regime Classifier"
          & ".\venv\Scripts\Activate.ps1"
          Write-Host "`n=== Starting Daily Pipeline ===" -ForegroundColor Cyan
          python scripts/daily_automation.py --build-features
          
      - name: Report pipeline status
        if: always()
        shell: powershell
        run: |
          Set-Location 'C:\Users\ahaan\CODE\Research Papers\ML Regime Classifier'

          $timelinePath = 'features\regime_timeline_history.csv'
          $runLogPath   = 'logs\daily_automation_runs.jsonl'

          if (Test-Path $runLogPath) {
            $latestRun = Get-Content $runLogPath -Tail 1 | ConvertFrom-Json
            Write-Host ('Status:     {0}' -f $latestRun.status)
            if ($latestRun.error_step) { Write-Host ('Error step: {0}' -f $latestRun.error_step) }
            if ($latestRun.timestamp)  { Write-Host ('Last run:   {0}' -f $latestRun.timestamp) }
          } else {
            Write-Host 'Run log not found'
          }

          if (Test-Path $timelinePath) {
            $lines = (Get-Content $timelinePath | Measure-Object -Line).Lines - 1
            Write-Host ('Timeline rows: {0}' -f $lines)
          } else {
            Write-Host 'Timeline file not found'
          }

